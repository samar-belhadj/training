podTemplate(
  inheritFrom: 'jenkins-agent',
  containers: [
    containerTemplate(name: 'node-container', image: 'node:18.4.0', alwaysPullImage: false, ttyEnabled: true, command: 'cat'),
  ]
) {
  node(POD_LABEL) {
    stage('Checkout project') {
      checkout([$class: 'GitSCM', branches: [[name: "main"]], userRemoteConfigs: [[url: 'https://github.com/samar-belhadj/training.git']]])
      
    }


    stage('Build ') {
      container('node-container') {
        
          sh """
            rm -rf package-lock.json
            npm install npm@latest -g
            npm run build
          """
        }
      
    }
    
    stage('Build Docker Image') {
      container('docker-daemon') {
          sh """
            docker build -t samarbelhadj/training:lts .
          """
        }
      }
    }

    stage('Push Docker Image') {
      container('docker-daemon') {
        withDockerRegistry(credentialsId: 'LETOacr', url: 'https://acrleto.azurecr.io') {
          dir('leto-modelizer') {
            sh """
              docker push  ${REPO_NAME}/${IMAGE_NAME}:${IMAGE_TAG}
            """
          }
        }
      }
    }

  }
}
